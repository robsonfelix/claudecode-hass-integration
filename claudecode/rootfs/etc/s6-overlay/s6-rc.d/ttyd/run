#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Start ttyd service
# ==============================================================================

# Read configuration
CONFIG_PATH="/data/options.json"

ENABLE_MCP=$(jq -r '.enable_mcp // true' "$CONFIG_PATH")
TERMINAL_FONT_SIZE=$(jq -r '.terminal_font_size // 14' "$CONFIG_PATH")
TERMINAL_THEME=$(jq -r '.terminal_theme // "dark"' "$CONFIG_PATH")
WORKING_DIR=$(jq -r '.working_directory // "/homeassistant"' "$CONFIG_PATH")
SESSION_PERSISTENCE=$(jq -r '.session_persistence // true' "$CONFIG_PATH")

# Set environment
export HOME=/root
export TERM=xterm-256color
export LANG=C.UTF-8
export LC_ALL=C.UTF-8
export SUPERVISOR_TOKEN="${SUPERVISOR_TOKEN:-}"
export HASS_SERVER="http://supervisor/core"
export HASS_TOKEN="${SUPERVISOR_TOKEN}"

# Setup MCP config
mkdir -p /root/.claude
if [[ "${ENABLE_MCP}" == "true" ]]; then
    cat > /root/.claude/settings.json << EOF
{
  "mcpServers": {
    "homeassistant": {
      "command": "hass-mcp",
      "env": {
        "HASS_TOKEN": "${SUPERVISOR_TOKEN}",
        "HASS_HOST": "http://supervisor/core"
      }
    }
  }
}
EOF
else
    echo '{}' > /root/.claude/settings.json
fi

# Verify working directory
if [[ ! -d "${WORKING_DIR}" ]]; then
    WORKING_DIR="/homeassistant"
fi
cd "${WORKING_DIR}" || cd /homeassistant

# Get theme
if [[ "${TERMINAL_THEME}" == "dark" ]]; then
    TTYD_THEME="background=#1e1e2e,foreground=#cdd6f4,cursor=#f5e0dc"
else
    TTYD_THEME="background=#eff1f5,foreground=#4c4f69,cursor=#dc8a78"
fi

# Shell command
if [[ "${SESSION_PERSISTENCE}" == "true" ]]; then
    SHELL_CMD="tmux new-session -A -s claude"
else
    SHELL_CMD="bash --login"
fi

# Start ttyd
exec ttyd \
    --port 7681 \
    --writable \
    --ping-interval 30 \
    --max-clients 5 \
    -t "fontSize=${TERMINAL_FONT_SIZE}" \
    -t "fontFamily=Monaco,Consolas,monospace" \
    -t "theme=${TTYD_THEME}" \
    ${SHELL_CMD}
